---
# Install cloudflared, deploy tunnel credentials and config
# DNS CNAME records are created by the miuops CLI via Cloudflare API

- name: Create cloudflared directory
  file:
    path: "{{ cloudflared_dir }}"
    state: directory
    mode: '0755'
  tags: ['cloudflared']

- name: Add Cloudflare GPG key
  get_url:
    url: "{{ cloudflared_gpg_key_url }}"
    dest: /etc/apt/keyrings/cloudflare-main.gpg
    mode: '0644'
  tags: ['cloudflared']

- name: Add Cloudflare apt repository
  apt_repository:
    repo: "{{ cloudflared_apt_repository }}"
    state: present
  tags: ['cloudflared']

- name: Install cloudflared
  apt:
    name: cloudflared
    state: latest
    update_cache: yes
  notify: Restart cloudflared
  tags: ['cloudflared']

- name: Check if credentials file exists
  stat:
    path: "{{ credentials_file }}"
  register: cf_credentials
  tags: ['cloudflared']

- name: Copy tunnel credentials if provided
  copy:
    src: "files/{{ tunnel_id }}.json"
    dest: "{{ credentials_file }}"
    mode: '0600'
  when: not cf_credentials.stat.exists
  ignore_errors: true
  register: credentials_copy
  tags: ['cloudflared']

- name: Warning about missing credentials file
  debug:
    msg: |
      WARNING: Tunnel credentials file wasn't found or couldn't be copied.
      You need to run 'cloudflared tunnel login' and 'cloudflared tunnel create <name>'
      manually on this server, then copy the JSON credentials to {{ credentials_file }}.
  when: not cf_credentials.stat.exists and (credentials_copy is failed or credentials_copy is skipped)
  tags: ['cloudflared']

- name: Deploy cloudflared config
  template:
    src: config.yml.j2
    dest: "{{ cloudflared_dir }}/config.yml"
    mode: '0644'
  notify: Restart cloudflared
  tags: ['cloudflared']

- name: Create systemd service for cloudflared
  template:
    src: cloudflared.service.j2
    dest: /etc/systemd/system/cloudflared.service
    mode: '0644'
  notify:
    - Reload systemd
    - Restart cloudflared
  tags: ['cloudflared']

- name: Enable and start cloudflared service
  systemd:
    name: cloudflared
    enabled: yes
    state: started
  tags: ['cloudflared']

- name: Flush handlers
  meta: flush_handlers
