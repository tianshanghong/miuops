---
# Traefik role: bootstrap server directories and upgrade Traefik image
# Compose deployment is handled by the user's GitOps stack repo

# ========== Bootstrap tasks (run on first setup) =============================

- name: Create Traefik directory
  file:
    path: "{{ traefik_dir }}"
    state: directory
    mode: '0755'
  tags: ['traefik']

- name: Create Traefik network
  community.docker.docker_network:
    name: traefik_network
    driver: bridge
  tags: ['traefik']

# ========== Upgrade tasks (idempotent â€” skipped if stack not yet deployed) ====

- name: Check if Traefik stack is deployed
  ansible.builtin.stat:
    path: /opt/stacks/traefik/docker-compose.yml
  register: traefik_stack_compose
  tags: ['traefik']

- name: Pull latest Traefik image and recreate container
  shell: >
    docker compose -f /opt/stacks/traefik/docker-compose.yml pull &&
    docker compose -f /opt/stacks/traefik/docker-compose.yml up -d
  when: traefik_stack_compose.stat.exists
  tags: ['traefik']
