---
# Traefik role: bootstrap server directories and upgrade Traefik image
# Compose deployment is handled by the user's GitOps stack repo

# ========== Bootstrap tasks (run on first setup) =============================

- name: Create stacks directory
  file:
    path: /opt/stacks
    state: directory
    mode: '0755'
  tags: ['traefik']

- name: Create stacks .env file
  copy:
    content: ""
    dest: /opt/stacks/.env
    mode: '0600'
    force: no
  tags: ['traefik']

# ========== Upgrade tasks (idempotent â€” skipped if stack not yet deployed) ====

- name: Check if Traefik stack is deployed
  ansible.builtin.stat:
    path: /opt/stacks/traefik/docker-compose.yml
  register: traefik_stack_compose
  tags: ['traefik']

- name: Pull latest Traefik image and recreate container
  shell: >
    docker compose -f /opt/stacks/traefik/docker-compose.yml pull &&
    docker compose -f /opt/stacks/traefik/docker-compose.yml up -d
  when: traefik_stack_compose.stat.exists
  tags: ['traefik']

- name: Reconnect Traefik to per-stack ingress networks
  shell: |
    for stack in /opt/stacks/*/; do
      stack="$(basename "$stack")"
      [ "$stack" = "traefik" ] && continue
      docker network connect "${stack}_ingress" traefik 2>/dev/null || true
    done
  when: traefik_stack_compose.stat.exists
  tags: ['traefik']
